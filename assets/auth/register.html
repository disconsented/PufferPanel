{{ define "content" }}

    {{ block "sidebar" . }} {{ "" }} {{ end }}

    {{ block "footer" . }} {{ "" }} {{ end }}

    {{ block "title" . }} Register {{ end }}

    {{ block "body" . }}
        <v-layout align-center justify-center>
            <v-flex xs12 sm8 md4>
                <material-card color="blue" title="Register" >
                    <v-container>
                        <v-card-text>
                            <v-card-text v-if="username && !validUsername">
                                <material-notification color="error">Username must be at least 8 characters and only contain alphanumerics, _, or -.</material-notification>
                            </v-card-text>
                            <v-card-text v-if="email && !validEmail">
                                <material-notification color="error">Email is not valid</material-notification>
                            </v-card-text>
                            <v-form>
                                <v-text-field v-model.trim="username" prepend-icon="person" name="username" label="Username" type="text"></v-text-field>
                                <v-text-field v-model.trim="email" prepend-icon="person" name="email" label="Email" type="text"></v-text-field>
                            </v-form>
                        </v-card-text>
                        <v-card-text>
                            <v-card-text v-if="password && confirmPassword && !samePassword">
                                <material-notification color="error">Passwords must be the same</material-notification>
                            </v-card-text>
                            <v-card-text v-if="password && !validPassword">
                                <material-notification color="error">Passwords must be at least 8 characters</material-notification>
                            </v-card-text>
                            <v-form>
                                <v-text-field v-model="password" id="password" prepend-icon="lock" name="password" label="Password" type="password"></v-text-field>
                                <v-text-field v-model="confirmPassword" id="confirmPassword" prepend-icon="lock" name="confirmPassword" label="Confirm Password" type="password"></v-text-field>
                            </v-form>
                        </v-card-text>
                    </v-container>
                    <v-container>
                        <v-card-text v-if="error">
                            <material-notification v-text="error" color="error"></material-notification>
                        </v-card-text>
                        <v-card-actions>
                            <a href="/auth/login">Login</a>
                            <v-spacer></v-spacer>
                            <v-btn :disabled="!canComplete" color="blue" v-on:click="submit">Register</v-btn>
                        </v-card-actions>
                    </v-container>
                </material-card>
            </v-flex>
        </v-layout>
    {{ end }}

    {{ block "scripts" . }}
        <script type="application/javascript" src="/assets/js/helper-offset.js"></script>
        <script type="application/javascript" src="/assets/js/material-card.js"></script>
        <script type="application/javascript" src="/assets/js/material-notification.js"></script>
        <script type="application/javascript" src="https://unpkg.com/axios/dist/axios.min.js"></script>

        <script>
            mixin = {
                methods: {
                    submit: function() {
                        if (!this.username) {
                            this.error = "Username is required";
                            return
                        }

                        if (!this.email) {
                            this.error = "Email is required";
                            return
                        }

                        if (!this.password) {
                            this.error = "Password is required";
                            return
                        }

                        if (!this.validPassword) {
                            this.error = "Password is not valid"
                        }
                        this.registerDisabled = true;

                        axios.post('/auth/register', {
                            data: {
                                email: this.email,
                                password: this.password,
                                username: this.username
                            }
                        }).then(function (response) {
                            let responseData = response.data;
                            if (responseData.success) {
                                window.location.href = "/auth/login";
                            } else {
                                data.error = responseData.msg;
                                data.registerDisabled = false;
                            }
                        }).catch(function (error) {
                            let msg = error.response.data.msg;
                            if (!msg) {
                                msg = error;
                            }
                            data.error = msg;
                            data.registerDisabled = false;
                        });
                    }
                },
                data: function() {
                    return {
                        username: "",
                        email: "",
                        password: "",
                        confirmPassword: "",
                        registerDisabled: false,
                        error: ""
                    }
                },
                computed: {
                    validPassword: function() {
                        return this.password.length >= 8;
                    },
                    samePassword: function() {
                        return this.password && this.confirmPassword && this.password === this.confirmPassword;
                    },
                    validEmail: function() {
                        return this.email && /^\S+@\S+\.\S+$/.test(this.email);
                    },
                    validUsername: function() {
                        return this.username && /^([0-9A-Za-z_\-]){8,}$/.test(this.username);
                    },
                    canComplete: function() {
                        if (this.registerDisabled) {
                            return false;
                        }

                        if (!this.username || !this.validUsername) {
                            return false;
                        }

                        if (!this.email || !this.validEmail) {
                            return false;
                        }

                        if (!this.validPassword || !this.samePassword) {
                            return false;
                        }

                        return true;
                    }
                }
            };
        </script>
    {{ end }}

{{ end }}